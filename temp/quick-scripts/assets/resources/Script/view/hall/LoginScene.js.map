{"version":3,"sources":["LoginScene.js"],"names":["serverConnect","require","requestHandler","onfire","tools","config","events","scenes","native","version","texts","consts","globalData","cc","Class","extends","Component","properties","btnWeChat","Button","btnPhone","btn_label","lblVersion","Label","start","isMobile","hideWeChatLogin","isIOS","onLoad","string","getVersion","isNetwork","connect","on","OPEN","onServerConnectOpen","ERROR","onServerConnectError","onLogout","obj","console","log","JSON","stringify","un","disableAutoLogin","localLogin","local_login","getLocalData","hall","LOCAL_LOGIN","token","data","phone","phoneCode","wechatCode","sendRequest","C2S_LOGIN","S2C_LOGIN","data1","data2","success","myUserInfo","userInfo","setLocalData","director","loadScene","HALL","fire","HALL_DATA","node","active","x","onClickedBtnWechat","$this","interactable","scheduleOnce","isAndroid","callJavaStaticMethod","android","PACKAGE_PATH","methods","IS_WECHAT_APP_INSTALLED","showMessage","WECHAT_INSTALL_FIRST","callJavaStaticMethod1","SET_WECHAT_LOGGING","WECHAT_LOGIN","schedule","checkWXLoginResult","result","IS_WECHAT_LOGGING","wxcode","GET_WECHAT_ACCESS_CODE","unschedule","_FAILED","toString","onClickedBtnPhone","LOGIN_PHONE","onClickedBtnAgree","EULA","onDestroy"],"mappings":"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","file":"LoginScene.js","sourceRoot":"../../../../../../../assets/resources/Script/view/hall","sourcesContent":["var serverConnect = require(\"ServerConnect\");\r\nvar requestHandler = require(\"RequestHandler\");\r\nvar onfire = require(\"onfire\");\r\nvar tools = require(\"Tools\");\r\nvar config = require(\"config\");\r\nvar events = require(\"CustomEvents\");\r\nvar scenes = require(\"SceneList\");\r\nvar native = require(\"NativeInterface\");\r\nvar version = require(\"Version\");\r\nvar texts = require(\"Text\");\r\nvar consts = require(\"Constants\");\r\nvar globalData = require(\"Global\");\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        btnWeChat: cc.Button,\r\n        btnPhone: cc.Button,\r\n        btn_label: cc.Button,\r\n        lblVersion: cc.Label,\r\n    },\r\n\r\n    start() {\r\n        // 根据环境决定是否显示微信登录按钮\r\n        if (!tools.isMobile()) {\r\n            this.hideWeChatLogin();\r\n        }\r\n\r\n        // iOS检测微信是否安装\r\n        if (tools.isIOS()) {\r\n            //TODO: 未安装微信则隐藏微信登录按钮\r\n        }\r\n    },\r\n\r\n    // use this for initialization\r\n    onLoad() {\r\n        // 版本号\r\n        this.lblVersion.string = version.getVersion();\r\n\r\n        if (config.isNetwork) {\r\n            serverConnect.connect(true);\r\n            onfire.on(events.onfire.OPEN, this.onServerConnectOpen);\r\n            onfire.on(events.onfire.ERROR, this.onServerConnectError);\r\n            globalData.onLogout();\r\n        }\r\n    },\r\n\r\n    onServerConnectError: function(obj) {\r\n        console.log(JSON.stringify(obj));\r\n    },\r\n\r\n    onServerConnectOpen: function() {\r\n        console.log(\"server connected\");\r\n        onfire.un(events.onfire.OPEN);\r\n\r\n        // 检测自动登录\r\n        if (!globalData.disableAutoLogin) {\r\n            var localLogin = false;\r\n            var local_login = tools.getLocalData(consts.hall.LOCAL_LOGIN);\r\n            console.log(\"local_login:\", local_login);\r\n            if (local_login) {\r\n                console.log(\"local_login.token:\", local_login.token);\r\n                if (local_login.token) {\r\n                    console.log(\"Auto login, token:\", local_login.token);\r\n                    var data = {\r\n                        phone: \"\",\r\n                        phoneCode: \"\",\r\n                        wechatCode: \"\",\r\n                        token: local_login.token,\r\n                    };\r\n                    requestHandler.sendRequest(events.hall.C2S_LOGIN, data);\r\n                }\r\n                localLogin = true;\r\n            }\r\n            if (localLogin) {\r\n                // 大厅登录信息\r\n                onfire.on(events.hall.S2C_LOGIN, function(data1, data2) {\r\n                    if (data1.success == 0) {\r\n                        console.log(JSON.stringify(data1));\r\n\r\n                        // 我的用户数据\r\n                        globalData.myUserInfo = data1.userInfo;\r\n\r\n                        // 保存本地信息\r\n                        var localLogin = {\r\n                            token: data1.userInfo.token,\r\n                        };\r\n                        tools.setLocalData(consts.hall.LOCAL_LOGIN, localLogin);\r\n\r\n                        // 切换场景\r\n                        cc.director.loadScene(scenes.hall.HALL, function() {\r\n                            onfire.fire(events.hall.HALL_DATA, data1, data2);\r\n                        });\r\n                    }\r\n\r\n                    onfire.un(events.hall.S2C_LOGIN);\r\n                });\r\n            }\r\n        } else {\r\n            globalData.disableAutoLogin = false;\r\n        }\r\n    },\r\n\r\n    // 隐藏微信登录\r\n    hideWeChatLogin: function() {\r\n        this.btnWeChat.node.active = false;\r\n        this.btnPhone.node.x = 0;\r\n    },\r\n\r\n    // 微信登录\r\n    onClickedBtnWechat: function() {\r\n        var $this = this;\r\n        console.log('微信登录');\r\n        this.btnWeChat.interactable = false;\r\n        this.scheduleOnce(function() {\r\n            $this.btnWeChat.interactable = true;\r\n        }, 5);\r\n\r\n        // 安卓\r\n        if (tools.isAndroid()) {\r\n            // 检测微信是否安装\r\n            if (!tools.callJavaStaticMethod(native.android.PACKAGE_PATH, native.android.methods.IS_WECHAT_APP_INSTALLED, \"()Z\")) {\r\n                tools.showMessage(texts.hall.WECHAT_INSTALL_FIRST);\r\n                return;\r\n            } else {\r\n                // 尝试向微信发送请求\r\n                tools.callJavaStaticMethod1(native.android.PACKAGE_PATH, native.android.methods.SET_WECHAT_LOGGING, \"(Z)V\", true);\r\n                tools.callJavaStaticMethod(native.android.PACKAGE_PATH, native.android.methods.WECHAT_LOGIN, \"()V\");\r\n\r\n                // 等待获取微信登录结果\r\n                this.schedule(this.checkWXLoginResult, 0.5);\r\n            }\r\n        }\r\n\r\n        // iOS\r\n        else if (tools.isIOS()) {}\r\n    },\r\n\r\n    // 检查微信登录结果\r\n    checkWXLoginResult: function() {\r\n        var result = tools.callJavaStaticMethod(native.android.PACKAGE_PATH, native.android.methods.IS_WECHAT_LOGGING, \"()Z\");\r\n        var wxcode = tools.callJavaStaticMethod(native.android.PACKAGE_PATH, native.android.methods.GET_WECHAT_ACCESS_CODE, \"()Ljava/lang/String;\");\r\n        if (!result) {\r\n            this.unschedule(this.checkWXLoginResult);\r\n        }\r\n        if (wxcode && wxcode != \"\") {\r\n            this.unschedule(this.checkWXLoginResult);\r\n            var data = {\r\n                phone: \"\",\r\n                phoneCode: \"\",\r\n                wechatCode: wxcode,\r\n                token: \"\"\r\n            };\r\n            requestHandler.sendRequest(events.hall.C2S_LOGIN, data);\r\n\r\n            // 大厅登录信息\r\n            onfire.on(events.hall.S2C_LOGIN, function(data1, data2) {\r\n                if (data1.success == 0) {\r\n                    console.log(JSON.stringify(data1));\r\n\r\n                    globalData.myUserInfo = data1.userInfo;\r\n\r\n                    // 保存本地信息\r\n                    var localLogin = {\r\n                        token: data1.userInfo.token,\r\n                    };\r\n                    tools.setLocalData(consts.hall.LOCAL_LOGIN, localLogin);\r\n\r\n                    // 切换场景\r\n                    cc.director.loadScene(scenes.hall.HALL, function() {\r\n                        onfire.fire(events.hall.HALL_DATA, data1, data2);\r\n                    });\r\n                } else {\r\n                    tools.showMessage(texts.hall._FAILED + data1.success.toString());\r\n                }\r\n\r\n                onfire.un(events.hall.S2C_LOGIN);\r\n            });\r\n        }\r\n    },\r\n\r\n    // 点击手机\r\n    onClickedBtnPhone: function() {\r\n        console.log('点击手机');\r\n        this.btnPhone.interactable = false;\r\n        this.scheduleOnce(function() {\r\n            $this.btnPhone.interactable = true;\r\n        }, 5);\r\n\r\n        cc.director.loadScene(scenes.hall.LOGIN_PHONE)\r\n    },\r\n\r\n    // 点击 同意文字\r\n    onClickedBtnAgree: function() {\r\n        console.log('点击用户条款');\r\n        cc.director.loadScene(scenes.hall.EULA);\r\n    },\r\n\r\n    onDestroy() {\r\n        onfire.un(events.hall.S2C_LOGIN);\r\n        onfire.un(events.onfire.OPEN);\r\n        onfire.un(events.onfire.ERROR);\r\n    }\r\n});"]}