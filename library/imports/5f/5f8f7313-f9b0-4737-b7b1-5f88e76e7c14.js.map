{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\resources\\Script/assets\\resources\\Script\\UpdateScene.js"],"names":["MAX_FAIL_COUNT","scenes","require","version","cc","Class","extends","Component","properties","prgBar","ProgressBar","lblPct","Label","_updating","_canRetry","_storagePath","_percent","lblVersion","checkCb","event","console","log","getEventCode","jsb","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","updateFinished","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","NEW_VERSION_FOUND","progress","string","hotUpdate","eventManager","removeListener","_checkListener","updateCb","needRestart","failed","UPDATE_PROGRESSION","getPercentByFile","parseInt","toString","msg","getMessage","UPDATE_FINISHED","UPDATE_FAILED","_failCount","retry","ERROR_UPDATING","getAssetId","ERROR_DECOMPRESS","_updateListener","searchPaths","fileUtils","getSearchPaths","newPaths","_am","getLocalManifest","JSON","stringify","Array","prototype","unshift","sys","localStorage","setItem","setSearchPaths","audioEngine","stopAll","game","restart","loadCustomManifest","getState","AssetsManager","State","UNINITED","manifest","Manifest","customManifestStr","loadLocalManifest","downloadFailedAssets","checkUpdate","manifestUrl","isLoaded","EventListenerAssetsManager","bind","addListener","update","onLoad","getVersion","isNative","getWritablePath","versionCompareHandle","versionA","versionB","vA","split","vB","i","length","a","b","ENABLE_GC_FOR_NATIVE_OBJECTS","retain","setVerifyCallback","path","asset","compressed","expectedMD5","md5","relativePath","size","os","OS_ANDROID","setMaxConcurrentTask","onDestroy","release","director","loadScene","hall","LOGIN_SCENE"],"mappings":"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","file":"UpdateScene.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\resources\\Script","sourcesContent":["const MAX_FAIL_COUNT = 1; //最大错误重试次数\r\nvar scenes = require(\"SceneList\");\r\nvar version = require(\"Version\");\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        prgBar: cc.ProgressBar,\r\n        lblPct: cc.Label,\r\n        _updating: false,\r\n        _canRetry: false,\r\n        _storagePath: \"\",\r\n        _percent: 0,\r\n        lblVersion: cc.Label,\r\n    },\r\n\r\n    checkCb: function(event) {\r\n        console.log('Code: ' + event.getEventCode());\r\n        switch (event.getEventCode()) {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                console.log(\"No local manifest file found, hot update skipped.\");\r\n                this.updateFinished();\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                console.log(\"Fail to download manifest file, hot update skipped.\");\r\n                this.updateFinished();\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                console.log(\"Already up to date with the latest remote version.\");\r\n                this.updateFinished();\r\n                break;\r\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\r\n                console.log('New version found, please try to update.');\r\n                this.prgBar.progress = 0;\r\n                this.lblPct.string = \"0%\";\r\n                this.hotUpdate();\r\n                break;\r\n            default:\r\n                return;\r\n        }\r\n\r\n        cc.eventManager.removeListener(this._checkListener);\r\n        this._checkListener = null;\r\n        this._updating = false;\r\n    },\r\n\r\n    updateCb: function(event) {\r\n        var needRestart = false;\r\n        var failed = false;\r\n        switch (event.getEventCode()) {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                console.log('No local manifest file found, hot update skipped.');\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\r\n                this.prgBar.progress = event.getPercentByFile();\r\n                this.lblPct.string = (parseInt(this.prgBar.progress * 100)).toString() + \"%\";\r\n\r\n                var msg = event.getMessage();\r\n                if (msg) {\r\n                    console.log('Updated file: ' + msg);\r\n                    // console.log(event.getPercent()/100 + '% : ' + msg);\r\n                }\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                console.log('Fail to download manifest file, hot update skipped.');\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                console.log('Already up to date with the latest remote version.');\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\r\n                console.log('Update finished. ' + event.getMessage());\r\n                needRestart = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FAILED:\r\n                console.log('Update failed. ' + event.getMessage());\r\n                this._updating = false;\r\n                this._canRetry = true;\r\n                if (++this._failCount < MAX_FAIL_COUNT) {\r\n                    this.retry();\r\n                } else {\r\n                    this.updateFinished();\r\n                }\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_UPDATING:\r\n                console.log('Asset update error: ' + event.getAssetId() + ', ' + event.getMessage());\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\r\n                console.log(event.getMessage());\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n\r\n        if (failed) {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n            this._updating = false;\r\n        }\r\n\r\n        if (needRestart) {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n            // Prepend the manifest's search path\r\n            var searchPaths = jsb.fileUtils.getSearchPaths();\r\n            var newPaths = this._am.getLocalManifest().getSearchPaths();\r\n            console.log(JSON.stringify(newPaths));\r\n            Array.prototype.unshift(searchPaths, newPaths);\r\n            // This value will be retrieved and appended to the default search path during game startup,\r\n            // please refer to samples/js-tests/main.js for detailed usage.\r\n            // !!! Re-add the search paths in main.js is very important, otherwise, new scripts won't take effect.\r\n            cc.sys.localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\r\n            jsb.fileUtils.setSearchPaths(searchPaths);\r\n\r\n            cc.audioEngine.stopAll();\r\n            cc.game.restart();\r\n        }\r\n    },\r\n\r\n    loadCustomManifest: function() {\r\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n            var manifest = new jsb.Manifest(customManifestStr, this._storagePath);\r\n            this._am.loadLocalManifest(manifest, this._storagePath);\r\n            console.log('Using custom manifest');\r\n        }\r\n    },\r\n\r\n    retry: function() {\r\n        if (!this._updating && this._canRetry) {\r\n            this._canRetry = false;\r\n\r\n            console.log('Retry failed Assets...');\r\n            this._am.downloadFailedAssets();\r\n        }\r\n    },\r\n\r\n    checkUpdate: function() {\r\n        if (this._updating) {\r\n            console.log('Checking or updating ...');\r\n            return;\r\n        }\r\n        console.log(\"local manifest:\", this.manifestUrl);\r\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n            this._am.loadLocalManifest(this.manifestUrl);\r\n        }\r\n        if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\r\n            console.log('Failed to load local manifest ...');\r\n            return;\r\n        }\r\n        this._checkListener = new jsb.EventListenerAssetsManager(this._am, this.checkCb.bind(this));\r\n        cc.eventManager.addListener(this._checkListener, 1);\r\n\r\n        this._am.checkUpdate();\r\n    },\r\n\r\n    hotUpdate: function() {\r\n        if (this._am && !this._updating) {\r\n            this._updateListener = new jsb.EventListenerAssetsManager(this._am, this.updateCb.bind(this));\r\n            cc.eventManager.addListener(this._updateListener, 1);\r\n\r\n            if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n                this._am.loadLocalManifest(this.manifestUrl);\r\n            }\r\n\r\n            this._failCount = 0;\r\n            this._am.update();\r\n            this._updating = true;\r\n        }\r\n    },\r\n\r\n    // use this for initialization\r\n    onLoad: function() {\r\n        this.lblVersion.string = version.getVersion();\r\n        this.manifestUrl = \"res/raw-assets/resources/project.manifest\";\r\n\r\n        // Hot update is only available in Native build\r\n        if (!cc.sys.isNative) {\r\n            console.log(\"Not native platform, skip hot update.\");\r\n            this.updateFinished();\r\n            return;\r\n        }\r\n        this._storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'update');\r\n        console.log('Storage path for remote asset : ' + this._storagePath);\r\n\r\n        // Setup your own version compare handler, versionA and B is versions in string\r\n        // if the return value greater than 0, versionA is greater than B,\r\n        // if the return value equals 0, versionA equals to B,\r\n        // if the return value smaller than 0, versionA is smaller than B.\r\n        this.versionCompareHandle = function(versionA, versionB) {\r\n            console.log(\"JS Custom Version Compare: version A is \" + versionA + ', version B is ' + versionB);\r\n            var vA = versionA.split('.');\r\n            var vB = versionB.split('.');\r\n            for (var i = 0; i < vA.length; ++i) {\r\n                var a = parseInt(vA[i]);\r\n                var b = parseInt(vB[i] || 0);\r\n                if (a === b) {\r\n                    continue;\r\n                } else {\r\n                    return a - b;\r\n                }\r\n            }\r\n            if (vB.length > vA.length) {\r\n                return -1;\r\n            } else {\r\n                return 0;\r\n            }\r\n        };\r\n\r\n        // Init with empty manifest url for testing custom manifest\r\n        this._am = new jsb.AssetsManager('', this._storagePath, this.versionCompareHandle);\r\n        if (!cc.sys.ENABLE_GC_FOR_NATIVE_OBJECTS) {\r\n            this._am.retain();\r\n        }\r\n\r\n        // Setup the verification callback, but we don't have md5 check function yet, so only print some message\r\n        // Return true if the verification passed, otherwise return false\r\n        this._am.setVerifyCallback(function(path, asset) {\r\n            // When asset is compressed, we don't need to check its md5, because zip file have been deleted.\r\n            var compressed = asset.compressed;\r\n            // Retrieve the correct md5 value.\r\n            var expectedMD5 = asset.md5;\r\n            // asset.path is relative path and path is absolute.\r\n            var relativePath = asset.path;\r\n            // The size of asset file, but this value could be absent.\r\n            var size = asset.size;\r\n            if (compressed) {\r\n                console.log(\"Verification passed : \" + relativePath);\r\n                return true;\r\n            } else {\r\n                console.log(\"Verification passed : \" + relativePath + ' (' + expectedMD5 + ')');\r\n                return true;\r\n            }\r\n        });\r\n\r\n        console.log('Hot update is ready, please check or directly update.');\r\n\r\n        if (cc.sys.os === cc.sys.OS_ANDROID) {\r\n            // Some Android device may slow down the download process when concurrent tasks is too much.\r\n            // The value may not be accurate, please do more test and find what's most suitable for your game.\r\n            this._am.setMaxConcurrentTask(2);\r\n            console.log(\"Max concurrent tasks count have been limited to 2\");\r\n        }\r\n\r\n        this.prgBar.progress = 0;\r\n        this.checkUpdate();\r\n    },\r\n\r\n    onDestroy: function() {\r\n        if (this._updateListener) {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n        }\r\n        if (this._am && !cc.sys.ENABLE_GC_FOR_NATIVE_OBJECTS) {\r\n            this._am.release();\r\n        }\r\n    },\r\n\r\n    updateFinished: function() {\r\n        cc.director.loadScene(scenes.hall.LOGIN_SCENE);\r\n    }\r\n});"]}