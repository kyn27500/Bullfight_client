{"version":3,"sources":["../../../../../../../assets/resources/Script/view/hall/assets/resources/Script/view/hall/LoginByPhone.js"],"names":["serverConnect","require","requestHandler","onfire","config","tools","events","scenes","native","texts","consts","globalData","cc","Class","extends","Component","properties","ebPhone","EditBox","btnCleanPhone","Button","ebEnterCode","btnSendCode","btnLogin","btnRetry","btnBack","onLoad","node","active","interactable","isNetwork","connect","onClickBtnSendCode","console","log","data","phone","string","sendRequest","hall","C2S_GET_PHONE_CODE","runCountdown","onClickBtnCleanPhone","onTextChanged","text","editbox","customEventData","length","isPoneAvailable","str","myreg","test","onTextDid","loginCallback","$this","JSON","stringify","result","onClickBtnLogin","scheduleOnce","phoneCode","wechatCode","token","C2S_LOGIN","on","S2C_LOGIN","data1","data2","success","myUserInfo","userInfo","localLogin","setLocalData","LOCAL_LOGIN","director","loadScene","HALL","fire","HALL_DATA","showMessage","LOGIN_FAILED","un","interval","repeat","delay","second","label","getChildByName","getComponent","Label","RETRY","SECOND_INITIAL","schedule","onClickBtnBack","LOGIN_SCENE","onDestroy"],"mappings":"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","file":"LoginByPhone.js","sourceRoot":"../../../../../../../assets/resources/Script/view/hall","sourcesContent":["var serverConnect = require(\"ServerConnect\");\r\nvar requestHandler = require(\"RequestHandler\");\r\nvar onfire = require(\"onfire\"); //处理事件的类库\r\nvar config = require(\"config\");\r\nvar tools = require(\"Tools\");\r\nvar events = require(\"CustomEvents\");\r\nvar scenes = require(\"SceneList\");\r\nvar native = require(\"NativeInterface\");\r\nvar texts = require(\"Text\");\r\nvar consts = require(\"Constants\");\r\nvar globalData = require(\"Global\");\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        ebPhone: cc.EditBox,\r\n        btnCleanPhone: cc.Button,\r\n        ebEnterCode: cc.EditBox,\r\n        btnSendCode: cc.Button,\r\n        btnLogin: cc.Button,\r\n        btnRetry: cc.Button,\r\n        btnBack: cc.Button,\r\n    },\r\n\r\n    onLoad() {\r\n        this.btnCleanPhone.node.active = false;\r\n        this.btnRetry.node.active = false;\r\n        this.btnLogin.interactable = false;\r\n        this.btnSendCode.interactable = false;\r\n        if (config.isNetwork) {\r\n            serverConnect.connect(true);\r\n        }\r\n    },\r\n\r\n\r\n    // 发送验证码\r\n    onClickBtnSendCode: function() {\r\n        // TODO 发送请求\r\n        console.log(\"发送验证码\");\r\n        var data = {\r\n            phone: this.ebPhone.string,\r\n        }\r\n        requestHandler.sendRequest(events.hall.C2S_GET_PHONE_CODE, data);\r\n        this.runCountdown();\r\n    },\r\n\r\n    // 清理手机号\r\n    onClickBtnCleanPhone: function() {\r\n        console.log(\"onClickBtnCleanPhone\");\r\n        this.ebPhone.string = '';\r\n        this.btnCleanPhone.node.active = false;\r\n        this.btnSendCode.interactable = false;\r\n    },\r\n\r\n    // 检测手机输入\r\n    onTextChanged: function(text, editbox, customEventData) {\r\n        if (text.length == 0) {\r\n            this.btnCleanPhone.node.active = false;\r\n        } else {\r\n            this.btnCleanPhone.node.active = true;\r\n        }\r\n\r\n        // 检测手机号\r\n        if (this.isPoneAvailable(text)) {\r\n            this.btnSendCode.interactable = true;\r\n        } else {\r\n            this.btnSendCode.interactable = false;\r\n        }\r\n    },\r\n\r\n    // 检测手机号\r\n    isPoneAvailable: function(str) {\r\n        var myreg = /^[1][3,4,5,7,8][0-9]{9}$/;\r\n        if (!myreg.test(str)) {\r\n            return false;\r\n        } else {\r\n            return true;\r\n        }\r\n    },\r\n\r\n    // 检测输入码\r\n    onTextDid: function(text, editbox, customEventData) {\r\n        if (text.length == 4) {\r\n            this.btnLogin.interactable = true;\r\n        } else {\r\n            this.btnLogin.interactable = false;\r\n        }\r\n    },\r\n\r\n    // 登录回调\r\n    loginCallback: function(data) {\r\n        var $this = this;\r\n        console.log(\"登录结果: \" + JSON.stringify(data));\r\n        if (data.result != 0) {\r\n            console.log(\"登录失败！\");\r\n        }\r\n    },\r\n\r\n    //登录\r\n    onClickBtnLogin: function() {\r\n        var $this = this;\r\n        console.log(\"尝试登录...手机号：\" + this.ebPhone.string + \", 验证码：\" + this.ebEnterCode.string);\r\n        this.btnLogin.interactable = false;\r\n        this.scheduleOnce(function () {\r\n            $this.btnLogin.interactable = true;\r\n        }, 5);\r\n\r\n        if (config.isNetwork) {\r\n            // 向服务端发送登录信息\r\n            var data = {\r\n                phone: this.ebPhone.string,\r\n                phoneCode: this.ebEnterCode.string,\r\n                wechatCode: \"\",\r\n                token: \"\",\r\n            };\r\n            requestHandler.sendRequest(events.hall.C2S_LOGIN, data);\r\n\r\n            // 大厅登录信息\r\n            onfire.on(events.hall.S2C_LOGIN, function(data1, data2) {\r\n                if (data1.success == 0) {\r\n                    console.log(JSON.stringify(data1));\r\n\r\n                    // 我的用户数据\r\n                    globalData.myUserInfo = data1.userInfo;\r\n\r\n                    // 保存本地信息\r\n                    var localLogin = {\r\n                        token: data1.userInfo.token,\r\n                    };\r\n                    tools.setLocalData(consts.hall.LOCAL_LOGIN, localLogin);\r\n\r\n                    // 切换场景\r\n                    cc.director.loadScene(scenes.hall.HALL, function() {\r\n                        onfire.fire(events.hall.HALL_DATA, data1, data2);\r\n                    });\r\n                } else {\r\n                    tools.showMessage(texts.hall.LOGIN_FAILED);\r\n                }\r\n\r\n                onfire.un(events.hall.S2C_LOGIN);\r\n            });\r\n        } else {\r\n            cc.director.loadScene(scenes.hall.HALL);\r\n        }\r\n\r\n    },\r\n\r\n    // 60s倒计时\r\n    runCountdown: function() {\r\n        this.btnSendCode.node.active = false;\r\n        // 以秒为单位的时间间隔\r\n        var interval = 1;\r\n        // 重复次数\r\n        var repeat = 61;\r\n        // 开始延时 \r\n        var delay = 0;\r\n        var second = 60;\r\n\r\n        this.btnRetry.node.active = true;\r\n        var label = this.btnRetry.node.getChildByName(\"Label\").getComponent(cc.Label);\r\n        label.string = texts.hall.RETRY + second + texts.hall.SECOND_INITIAL;\r\n        var $this = this;\r\n        this.btnSendCode.schedule(function() {\r\n            second -= 1;\r\n            label.string = texts.hall.RETRY + second + texts.hall.SECOND_INITIAL;\r\n            if (second < 0) {\r\n                $this.btnSendCode.node.active = true;\r\n                $this.btnRetry.node.active = false;\r\n            }\r\n        }, interval, repeat, delay);\r\n    },\r\n\r\n    // 点击返回\r\n    onClickBtnBack: function() {\r\n        cc.director.loadScene(scenes.hall.LOGIN_SCENE)\r\n    },\r\n\r\n    onDestroy() {\r\n        onfire.un(events.hall.S2C_LOGIN);\r\n    },\r\n});"]}